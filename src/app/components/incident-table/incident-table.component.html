<div class="search-container">
  <input 
    type="text" 
    placeholder="Search..." 
    (input)="onSearchChange($event)"
  >
</div>

<div *ngIf="loading">Loading...</div>
<!-- List view -->
<ng-template #listTpl>
  <div class="list-header">
    <h3>Incident Tracker</h3>
    <button class="primary" (click)="showCreate()">New Incident</button>
  </div>

  <table class="incident-table">
    <thead>
      <tr>
        <th (click)="setSort('title')">Title</th>
        <th (click)="setSort('service')">Service</th>
        <th (click)="setSort('severity')">Severity</th>
        <th (click)="setSort('status')">Status</th>
        <th>Owner</th>
        <th (click)="setSort('createdAt')">Created</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let incident of incidents" (click)="openDetail(incident)" class="clickable">
        <td>{{incident.title}}</td>
        <td>{{incident.service}}</td>
        <td>{{incident.severity}}</td>
        <td>{{incident.status}}</td>
        <td>{{incident.owner || '-'}}</td>
        <td>{{incident.createdAt | date:'short'}}</td>
      </tr>
    </tbody>
  </table>

  <div class="pagination">
    <button (click)="setPage(page-1)" [disabled]="page <= 1">Prev</button>
    <span>Page {{page}} / {{totalPages}}</span>
    <button (click)="setPage(page+1)" [disabled]="page >= totalPages">Next</button>
  </div>
</ng-template>

<!-- Detail view -->
<ng-template #detailTpl>
  <div class="detail-panel">
    <h2>Incident Tracker</h2>
    <h3>{{selectedIncident?.title}}</h3>

    <div class="field"><strong>Service:</strong> {{selectedIncident?.service}}</div>

    <div class="field">
      <label>Severity:</label>
      <select [(ngModel)]="selectedIncident!.severity">
        <option value="SEV1">SEV1</option>
        <option value="SEV2">SEV2</option>
        <option value="SEV3">SEV3</option>
        <option value="SEV4">SEV4</option>
      </select>
    </div>

    <div class="field">
      <label>Status:</label>
      <select [(ngModel)]="selectedIncident!.status">
        <option value="OPEN">Open</option>
        <option value="MITIGATED">Mitigated</option>
        <option value="RESOLVED">Resolved</option>
      </select>
    </div>

    <div class="field">
      <label>Assigned To:</label>
      <input [(ngModel)]="selectedIncident!.owner" />
    </div>

    <div class="field"><strong>Occurred At:</strong> {{selectedIncident?.createdAt | date:'longDate'}}</div>

    <div class="field">
      <label>Summary</label>
      <textarea [(ngModel)]="selectedIncident!.summary"></textarea>
    </div>

    <div class="actions">
      <button class="primary" (click)="saveChanges()">Save Changes</button>
      <button (click)="cancelView()">Cancel</button>
    </div>
  </div>
</ng-template>

<!-- Create view -->
<ng-template #createTpl>
  <div class="create-panel">
    <h2>Create New Incident</h2>

    <div class="field">
      <label>Title</label>
      <input [(ngModel)]="creating.title" placeholder="Issue Title..." />
    </div>

    <div class="field">
      <label>Service</label>
      <input [(ngModel)]="creating.service" placeholder="Select Service" />
    </div>

    <div class="field">
      <label>Severity</label>
      <label><input type="radio" name="sev" value="SEV1" [(ngModel)]="creating.severity"> SEV1</label>
      <label><input type="radio" name="sev" value="SEV2" [(ngModel)]="creating.severity"> SEV2</label>
      <label><input type="radio" name="sev" value="SEV3" [(ngModel)]="creating.severity"> SEV3</label>
      <label><input type="radio" name="sev" value="SEV4" [(ngModel)]="creating.severity"> SEV4</label>
    </div>

    <div class="field">
      <label>Status</label>
      <select [(ngModel)]="creating.status">
        <option value="OPEN">Open</option>
        <option value="MITIGATED">Mitigated</option>
        <option value="RESOLVED">Resolved</option>
      </select>
    </div>

    <div class="field">
      <label>Assigned To</label>
      <input [(ngModel)]="creating.owner" placeholder="Optional" />
    </div>

    <div class="field">
      <label>Summary</label>
      <textarea [(ngModel)]="creating.summary" placeholder="Describe the incident..."></textarea>
    </div>

    <div class="actions">
      <button class="primary" (click)="createIncident()">Create Incident</button>
      <button (click)="cancelView()">Cancel</button>
    </div>
  </div>
</ng-template>

<!-- Choose which template to render -->
<div *ngIf="!loading">
  <ng-container *ngIf="view === 'list'" [ngTemplateOutlet]="listTpl"></ng-container>
  <ng-container *ngIf="view === 'detail'" [ngTemplateOutlet]="detailTpl"></ng-container>
  <ng-container *ngIf="view === 'create'" [ngTemplateOutlet]="createTpl"></ng-container>
</div>
